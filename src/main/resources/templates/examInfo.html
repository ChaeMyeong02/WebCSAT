<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ì‹œí—˜ ì •ë³´ í™•ì¸</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function openEditModal(btn) {
      const subclassInput = document.getElementById('editSubclassId');
      const csatInput = document.getElementById('editCsatDate');
      if (!subclassInput || !csatInput) {
        alert("í•„ìˆ˜ ì…ë ¥ ìš”ì†Œê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
        return;
      }

      subclassInput.value = btn.dataset.subclassId;
      csatInput.value = btn.dataset.csatDate;

for (let i = 1; i <= 9; i++) {
  const input = document.getElementById(`editCut${i}`);
  const value = btn.dataset[`cut${i}`];
  console.log(`cut${i} =`, value);
  if (input) {
    input.value = value && value !== "null" ? value : '';
  }
}


      const modalElement = document.getElementById('editCutModal');
      if (!modalElement) {
        alert("ëª¨ë‹¬ ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const modal = new bootstrap.Modal(modalElement);
      modal.show();
    }

async function saveCutChanges() {
  const subclassId = document.getElementById('editSubclassId').value;
  const csatDate = document.getElementById('editCsatDate').value;
  const cuts = [];

  for (let i = 1; i <= 9; i++) {
    const input = document.getElementById(`editCut${i}`);
    cuts.push(parseInt(input.value || 0));
  }

  const token = localStorage.getItem("token");

  const res = await fetch('/api/cuts', {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({ subclassId, csatDate, cuts })
  });

  if (res.ok) {
    alert('ìˆ˜ì • ì™„ë£Œ');
    location.reload();
  } else {
    const msg = await res.text();
    alert('ìˆ˜ì • ì‹¤íŒ¨: ' + msg);
  }
}

  </script>
  <style>
    .gradient-custom {
      background: linear-gradient(to right, #0062E6, #33AEFF);
    }
  </style>
</head>

<body class="gradient-custom d-flex flex-column min-vh-100">
<th:block th:replace="~{fragments/commonHeader :: header}"></th:block>

<main class="container flex-grow-1 py-5">
  <h2 class="text-white text-center mb-4">ì‹œí—˜ ì •ë³´ í™•ì¸</h2>
  <!-- ê²€ìƒ‰ í¼ -->
  <form class="row mb-4 g-2" method="get" th:action="@{/admin/examInfo}">
    <div class="col-md-4">
      <input type="text" class="form-control" name="subject" placeholder="ê³¼ëª©ëª… ê²€ìƒ‰" th:value="${param.subject}">
    </div>
    <div class="col-md-4">
      <input type="text" class="form-control" name="csatDate" placeholder="ì‹œí—˜ì¼ì ê²€ìƒ‰ (ì˜ˆ: 2024ë…„11ì›”)" th:value="${param.csatDate}">
    </div>
    <div class="col-md-4">
      <button class="btn btn-light w-100" type="submit">ğŸ” ê²€ìƒ‰</button>
    </div>
  </form>

  <!-- ğŸ“‹ ì‹œí—˜ ì •ë³´ í…Œì´ë¸” -->
  <div class="card p-3">
    <table class="table table-bordered table-hover text-center align-middle">
      <thead class="table-primary">
      <tr>
        <th>ê³¼ëª©</th>
        <th>ì„¸ë¶€ê³¼ëª©</th>
        <th>ì‹œí—˜ì¼ì</th>
        <th>ë“£ê¸° ì—¬ë¶€</th>
        <th colspan="9">ë“±ê¸‰ì»·</th>
        <th>ìˆ˜ì •</th>
      </tr>
      <tr>
        <th colspan="4"></th>
        <th>1ë“±ê¸‰</th><th>2ë“±ê¸‰</th><th>3ë“±ê¸‰</th><th>4ë“±ê¸‰</th><th>5ë“±ê¸‰</th>
        <th>6ë“±ê¸‰</th><th>7ë“±ê¸‰</th><th>8ë“±ê¸‰</th><th>9ë“±ê¸‰</th>
        <th></th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="dto : ${examList}">
        <td th:text="${dto.subjectName}">êµ­ì–´</td>
        <td th:text="${dto.subclassName}">í™”ë²•ê³¼ ì‘ë¬¸</td>
        <td th:text="${dto.csatDate}">2024ë…„11ì›”</td>
        <td><span th:text="${dto.listeningUrl != null ? 'O' : 'X'}"></span></td>
        <td th:text="${dto.cut1}">-</td>
        <td th:text="${dto.cut2}">-</td>
        <td th:text="${dto.cut3}">-</td>
        <td th:text="${dto.cut4}">-</td>
        <td th:text="${dto.cut5}">-</td>
        <td th:text="${dto.cut6}">-</td>
        <td th:text="${dto.cut7}">-</td>
        <td th:text="${dto.cut8}">-</td>
        <td th:text="${dto.cut9}">-</td>
        <td>
          <button
                  class="btn btn-sm btn-outline-primary"
                  th:data-subclass-id="${dto.subclassId}"
                  th:data-csat-date="${dto.csatDate}"
                  th:data-cut1="${dto.cut1}"
                  th:data-cut2="${dto.cut2}"
                  th:data-cut3="${dto.cut3}"
                  th:data-cut4="${dto.cut4}"
                  th:data-cut5="${dto.cut5}"
                  th:data-cut6="${dto.cut6}"
                  th:data-cut7="${dto.cut7}"
                  th:data-cut8="${dto.cut8}"
                  th:data-cut9="${dto.cut9}"
                  onclick="openEditModal(this)">
            ìˆ˜ì •
          </button>

        </td>
      </tr>
      </tbody>
    </table>
  </div>
</main>

<div class="modal fade" id="editCutModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">ë“±ê¸‰ì»· ìˆ˜ì •</h5></div>
      <div class="modal-body">
        <input type="hidden" id="editSubclassId">
        <input type="hidden" id="editCsatDate">
        <div class="row g-2">
          <div class="col-4" th:each="i : ${#numbers.sequence(1,9)}">
            <label class="form-label" th:for="|editCut${i}|" th:text="|${i}ë“±ê¸‰|">ë“±ê¸‰</label>
            <input type="number" class="form-control"
                   th:id="|editCut${i}|"
                   th:name="|editCut${i}|">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
        <button class="btn btn-primary" onclick="saveCutChanges()">ì €ì¥</button>
      </div>
    </div>
  </div>
</div>



</body>
</html>
