<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ì„ì•¤ì¥CBT</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    .label-small {
      font-size: 0.85rem;
      color: #6c757d;
    }
    .personal-color.kakao {
      background-color: #FEE500;
    }
    .personal-color.google {
      background-color: #4285F4;
      color: white;
    }
    .personal-color.naver {
      background-color: #03C75A;
      color: white;
    }
  </style>
</head>
<body class="gradient-custom d-flex flex-column min-vh-100">
<th:block th:replace="~{fragments/commonHeader :: header}"></th:block>

<main class="container py-5">
  <div class="card mx-auto shadow-lg" style="max-width: 500px;">
    <div class="card-body">
      <h3 class="card-title text-center mb-4">ë‚´ ì •ë³´</h3>

      <!-- ì´ë©”ì¼ (readonly) -->
      <div class="mb-3">
        <label class="form-label">ì´ë©”ì¼</label>
        <input type="email" class="form-control" id="email" readonly>
      </div>

      <!-- ì´ë¦„ (ìˆ˜ì • ê°€ëŠ¥) -->
      <div class="mb-3">
        <label class="form-label">ì´ë¦„</label>
        <div class="input-group">
          <input type="text" class="form-control" id="nameInput" maxlength="20" placeholder="ìµœëŒ€ 20ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥">
          <button class="btn btn-primary" type="button" onclick="saveUserInfo()">ìˆ˜ì •í•˜ê¸°</button>
        </div>
      </div>


      <!-- ìœ ì € ì½”ë“œ -->
      <div class="mb-3">
        <label class="form-label">ìœ ì € ì½”ë“œ</label>
        <p class="label-small" id="userId"></p>
      </div>

      <!-- ìƒì„±ì¼ -->
      <div class="mb-3">
        <label class="form-label">ê°€ì…ì¼</label>
        <p class="label-small" id="createdAt"></p>
      </div>

      <!-- OAuth2 ë°©ì‹ -->
      <div class="mb-3">
        <label class="form-label">ë¡œê·¸ì¸ ë°©ì‹</label>
        <span class="badge personal-color" id="provider">OAUTH</span>
      </div>

      <!-- ê´€ë¦¬ì í‘œì‹œ -->
      <div class="mb-3" id="adminWrapper" style="display: none;">
        <label class="form-label">ê³„ì • ê¶Œí•œ</label>
        <span class="badge bg-danger" id="adminBadge">ê´€ë¦¬ì ê³„ì •</span>
      </div>

    </div>
    <!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
    <div class="m-3">
      <button class="btn btn-outline-secondary w-100" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>
  <!-- íšŒì›íƒˆí‡´ ë²„íŠ¼ (ì˜¤ë¥¸ìª½ í•˜ë‹¨) -->
  <button class="btn btn-sm btn-danger position-fixed" style="bottom: 20px; right: 20px;" onclick="confirmDelete()">
    íšŒì›íƒˆí‡´
  </button>
</main>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const token = localStorage.getItem("token");

    fetch("/api/user/me", {
      method: "GET",
      headers: {
        "Authorization": "Bearer " + token
      }
    })
    .then(res => {
      if (!res.ok) throw new Error("ì¸ì¦ ì‹¤íŒ¨");
      return res.json();
    })
    .then(data => {
      document.getElementById("email").value = data.email;
      document.getElementById("nameInput").value = data.nickname;
      document.getElementById("userId").innerText = "#" + data.userId;
      document.getElementById("createdAt").innerText = new Date(data.created_at).toLocaleString();

      const providerSpan = document.getElementById("provider");
      providerSpan.innerText = data.oauth2.toUpperCase();

      const colorClass = {
        kakao: "kakao",
        google: "google",
        naver: "naver"
      }[data.oauth2];
      providerSpan.classList.add(colorClass);

      window.userRole = data.role; // ğŸ”¥ ì—¬ê¸° ì¶”ê°€

      if (data.role === 'ADMIN') {
        document.getElementById("adminWrapper").style.display = "block";
      }
    })
    .catch(err => {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      location.href = "/login";
    });
  });

  function saveUserInfo() {
    const token = localStorage.getItem("token");
    const name = document.getElementById("nameInput").value;

    fetch("/api/user/me", {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ nickname: name })
    })
    .then(res => {
      if (!res.ok) throw new Error("ìˆ˜ì • ì‹¤íŒ¨");
      alert("ì €ì¥ ì™„ë£Œ");
      location.reload();
    })
    .catch(err => {
      alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
    });
  }
</script>
<script>
  function logout() {
    localStorage.removeItem("token");
    location.href = "/login";
  }

  function confirmDelete() {
    if (window.userRole === 'ADMIN') {
      alert("ê´€ë¦¬ì ê³„ì •ì€ íƒˆí‡´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    if (!confirm("ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    if (!confirm("ì§„ì§œë¡œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;

    const token = localStorage.getItem("token");

    fetch("/api/user/me", {
      method: "DELETE",
      headers: {
        "Authorization": "Bearer " + token
      }
    })
    .then(res => {
      if (!res.ok) throw new Error("íƒˆí‡´ ì‹¤íŒ¨");
      localStorage.removeItem("token");
      alert("íšŒì›íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      logout(); // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
    })
    .catch(err => {
      alert("íšŒì›íƒˆí‡´ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
    });
  }

</script>

<script src="/js/token.js"></script>
</body>
</html>
